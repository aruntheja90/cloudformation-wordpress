# Note, the development environment will only spin a min of 1 instance (Not HA Support)
# The production environment will spin a min of 2 instance (HA support)
# You can adjust the ASMIN, ASMAX, ASDES at the master.yaml file
# to meet your instances spin numbers.
#
---
AWSTemplateFormatVersion: "2010-09-09"
Description: >
    This template deploys an AutoScaling Launch Config and Group for WebServer

Parameters: 

  PMServerEnv:
    Description: "Server Environment name."
    ConstraintDescription: "Choose an Environment from the drop down"
    Type: "String"

  PMKeyName:
    Description: "Enter an existing EC2 KeyPair. Default is MyEC2Key"
    Type: "String"

  PMInstanceType: 
    Description: "Enter t2.micro or m1.small. Default is t2.micro."
    Type: "String"

  PMPublicSubnets:
    Description: "Subnets to launch instances into"
    Type: "List<AWS::EC2::Subnet::Id>"

  MyWordpressHostSG:
    Description: "Select the Security Group to use for the EC2 hosts"
    Type: "AWS::EC2::SecurityGroup::Id"

  PMWEBDOMAIN:
    Description: "A reference to the Webserver domain name"
    Type: "String"

  PMWordpressVer:
    Description: "Enter an wordpress version."
    Type: "String"

  PMS3Backup:
    Description: "S3 Backup Bucket Name"
    Type: "String"

  PMAPPLoadBalancerUrl:
    Description: "A reference to the AppServer Load Balancer"
    Type: "String"

  PMWEBLoadBalancer:
    Description: "A reference to the Webserver Load Balancer"
    Type: "String"

  PMIAMS3CWInstanceProfile:
    Description: "A reference to the IamInstanceProfile"
    Type: "String"

  PMRegionAMI:
    Description: "A reference to the Region AMI"
    Type: "String"

  PMASMIN:
    Description: "A reference to the MinSize"
    Type: "String"

  PMASMAX:
    Description: "A reference to the MaxSize"
    Type: "String"

  PMASDES:
    Description: "A reference to the DesiredCapacity"
    Type: "String"


Resources:

  # Auto Scaling Launch Configuration
  LaunchConfiguration:
    Type: "AWS::AutoScaling::LaunchConfiguration"
    Properties:
      AssociatePublicIpAddress: "true"
      KeyName:
        Ref: "PMKeyName"
      ImageId:
        Ref: "PMRegionAMI"
      InstanceType:
        Ref: "PMInstanceType"
      IamInstanceProfile:
        Ref: "PMIAMS3CWInstanceProfile"
      SecurityGroups:
      - Ref: "MyWordpressHostSG"
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash -xe

          # Install Nginx Repo
          wget http://nginx.org/keys/nginx_signing.key
          apt-key add nginx_signing.key
          echo 'deb http://nginx.org/packages/debian/ jessie nginx' > /etc/apt/sources.list.d/nginx.list
          echo 'deb-src http://nginx.org/packages/debian/ jessie nginx' >> /etc/apt/sources.list.d/nginx.list

          apt-get update && apt-get upgrade -y
          apt-get install -y php5-fpm php5-curl php5-gd php5-mcrypt php5-mhash php5-mysql php5-xmlrpc php-gettext php5-cli php5-dev smarty3
          apt-get install -y nginx telnet git python-pip dnsutils default-jdk screen locales tcpdump openssl rsync curl
          # pip install https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz

          # Install AWS cfn-bootstrap utilities
          apt-get -y install python-setuptools
          easy_install https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz

          # Pre-Install & Pre-setup
          export DEBIAN_FRONTEND=noninteractive
          # apt-get install -y xfsprogs dracut numactl
          # apt-get -q -y install mdadm --no-install-recommends
          # sudo touch /var/lib/cloud/instance/locale-check.skip
          echo 'LC_ALL="en_US.UTF-8"' >> /etc/default/locale
          echo '${PMWEBDOMAIN}' > /etc/hostname
          # Update hostname on the fly
          hostname ${PMWEBDOMAIN}

          count=$(aws s3 ls "${PMS3Backup}" | wc -l)
          if [ $count != 0 ]
          then 
          # File aready exist! (sync s3 backup to site-folder)
          mkdir -p /home/www/public_html/${PMWEBDOMAIN}
          aws s3 sync --sse s3://${PMS3Backup}/ /home/www/public_html/${PMWEBDOMAIN}/
          chown -R www-data:www-data /home/www/public_html/${PMWEBDOMAIN}
          chmod -R +x /home/www/public_html/${PMWEBDOMAIN}
          # Setup Crontab
          crontab -l | { cat; echo '*/2 * * * * aws s3 sync --sse --no-follow-symlinks /home/www/public_html/${PMWEBDOMAIN}/ s3://${PMS3Backup}/ > /dev/null 2>&1'; } | crontab -
          crontab -l | { cat; echo '*/3 * * * * aws s3 sync --sse s3://${PMS3Backup}/ /home/www/public_html/${PMWEBDOMAIN}/ > /dev/null 2>&1'; } | crontab -
          /etc/init.d/cron restart
          else
          # File don't exist (download wordpress)
          mkdir -p /home/www/public_html
          cd /home/www/public_html/
          wget https://wordpress.org/wordpress-${PMWordpressVer}.tar.gz
          tar -xf wordpress-${PMWordpressVer}.tar.gz
          rm -rf wordpress-${PMWordpressVer}.tar.gz
          mv wordpress ${PMWEBDOMAIN}
          chown -R www-data:www-data /home/www/public_html/${PMWEBDOMAIN}
          chmod -R +x /home/www/public_html/${PMWEBDOMAIN}
          aws s3 sync --sse /home/www/public_html/${PMWEBDOMAIN}/ s3://${PMS3Backup}/
          # Setup Crontab
          crontab -l | { cat; echo '*/2 * * * * aws s3 sync --sse --no-follow-symlinks /home/www/public_html/${PMWEBDOMAIN}/ s3://${PMS3Backup}/ > /dev/null 2>&1'; } | crontab -
          crontab -l | { cat; echo '*/3 * * * * aws s3 sync --sse s3://${PMS3Backup}/ /home/www/public_html/${PMWEBDOMAIN}/ > /dev/null 2>&1'; } | crontab -
          /etc/init.d/cron restart
          fi

          # Update php config
          sed -i 's/session.gc_maxlifetime = 1440/session.gc_maxlifetime = 3600/g' /etc/php5/fpm/php.ini
          sed -i 's/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/g' /etc/php5/fpm/php.ini
          sed -i 's/;include_path = \".:\/usr\/share\/php\"/include_path = \".:\/usr\/share\/php:\/usr\/share\/php\/smarty3\"/g' /etc/php5/fpm/php.ini
          sed -i 's/;mbstring.language = Japanese/mbstring.language = Neutral/g' /etc/php5/fpm/php.ini
          sed -i 's/;mbstring.internal_encoding =/mbstring.internal_encoding = UTF-8/g' /etc/php5/fpm/php.ini
          sed -i 's/;mbstring.encoding_translation = Off/mbstring.encoding_translation = On/g' /etc/php5/fpm/php.ini
          sed -i 's/;mbstring.http_input =/mbstring.http_input = auto/g' /etc/php5/fpm/php.ini
          sed -i 's/;mbstring.http_output =/mbstring.http_output = UTF-8/g' /etc/php5/fpm/php.ini
          sed -i 's/;mbstring.detect_order = auto/mbstring.detect_order = auto/g' /etc/php5/fpm/php.ini
          sed -i 's/;mbstring.substitute_character = none/mbstring.substitute_character = none/g' /etc/php5/fpm/php.ini
          sed -i 's/;mbstring.func_overload = 0/mbstring.func_overload = 7/g' /etc/php5/fpm/php.ini

          ######################################################################
          # Create custom Nginx directory
          ######################################################################
          # mkdir -p /etc/nginx/conf.d
          # mkdir -p /etc/nginx/sites-enabled
          # mkdir -p /etc/nginx/sites-available

          ######################################################################
          # Configure Nginx.conf
          ######################################################################
          # echo "user www-data;
          # worker_processes auto;
          # pid /var/run/nginx.pid;
       
          # events {
          # worker_connections 1024;
          # multi_accept on;
          # use epoll;
          # }
       
          # worker_rlimit_nofile 10000;

          # http {

          # ##
          # # Basic Settings 
          # ##
          # sendfile on;
          # tcp_nopush on;
          # tcp_nodelay on;
          # keepalive_timeout 65;
          # types_hash_max_size 2048;
          # server_tokens off;
         
          # include /etc/nginx/mime.types;
          # default_type application/octet-stream;
         
          # # set client body size to 32M #
          # client_max_body_size 32M;

          # ##
          # # Logging Settings
          # ##
          # access_log /var/log/nginx/access.log;
          # error_log /var/log/nginx/error.log;
         
          # ##
          # # Gzip Settings
          # ##
          # gzip on;
          # gzip_disable "msie6";
          # gzip_static on;
          # gzip_vary on;
          # gzip_proxied any;
          # gzip_comp_level 9;
          # gzip_buffers 16 8k;
          # gzip_http_version 1.1;
          # gzip_types text/plain text/css text/csv application/json application/javascript application/x-javascript image/x-icon text/xml application/xml application/xml+rss text/javascript;
       
          # ##
          # # open_file_cache optimization
          # ##
          # open_file_cache max=200000 inactive=50s;
          # open_file_cache_valid 60s;
          # open_file_cache_min_uses 2;
          # open_file_cache_errors on;
       
          # ##
          # # Virtual Host Configs
          # ##
          # include /etc/nginx/conf.d/*.conf;
          # include /etc/nginx/sites-enabled/*;
          # }" > /etc/nginx/nginx.conf

          ######################################################################
          # Configure proxy.conf
          ######################################################################
          # echo "proxy_redirect		off;
          # proxy_set_header	Host \$host;
          # proxy_set_header	X-Real-IP \$remote_addr;
          # proxy_set_header	X-Forwarded-For \$proxy_add_x_forwarded_for;
          # client_body_buffer_size	256K;
          # client_max_body_size	12m;
          # proxy_connect_timeout	600;
          # proxy_send_timeout	600;
          # proxy_read_timeout	600;
          # proxy_buffer_size	128k;
          # proxy_buffers		4 256k;
          # proxy_busy_buffers_size	256k;" > /etc/nginx/proxy.conf

          ######################################################################
          # Install Certificate
          ######################################################################
          # echo "-----BEGIN CERTIFICATE-----
          # MIIDdTCCAl2gAwIBAgILBAAAAAABFUtaw5QwDQYJKoZIhvcNAQEFBQAwVzELMAkG
          # A1UEBhMCQkUxGTAXBgNVBAoTEEdsb2JhbFNpZ24gbnYtc2ExEDAOBgNVBAsTB1Jv
          # b3QgQ0ExGzAZBgNVBAMTEkdsb2JhbFNpZ24gUm9vdCBDQTAeFw05ODA5MDExMjAw
          # MDBaFw0yODAxMjgxMjAwMDBaMFcxCzAJBgNVBAYTAkJFMRkwFwYDVQQKExBHbG9i
          # YWxTaWduIG52LXNhMRAwDgYDVQQLEwdSb290IENBMRswGQYDVQQDExJHbG9iYWxT
          # aWduIFJvb3QgQ0EwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDaDuaZ
          # jc6j40+Kfvvxi4Mla+pIH/EqsLmVEQS98GPR4mdmzxzdzxtIK+6NiY6arymAZavp
          # xy0Sy6scTHAHoT0KMM0VjU/43dSMUBUc71DuxC73/OlS8pF94G3VNTCOXkNz8kHp
          # 1Wrjsok6Vjk4bwY8iGlbKk3Fp1S4bInMm/k8yuX9ifUSPJJ4ltbcdG6TRGHRjcdG
          # snUOhugZitVtbNV4FpWi6cgKOOvyJBNPc1STE4U6G7weNLWLBYy5d4ux2x8gkasJ
          # U26Qzns3dLlwR5EiUWMWea6xrkEmCMgZK9FGqkjWZCrXgzT/LCrBbBlDSgeF59N8
          # 9iFo7+ryUp9/k5DPAgMBAAGjQjBAMA4GA1UdDwEB/wQEAwIBBjAPBgNVHRMBAf8E
          # BTADAQH/MB0GA1UdDgQWBBRge2YaRQ2XyolQL30EzTSo//z9SzANBgkqhkiG9w0B
          # AQUFAAOCAQEA1nPnfE920I2/7LqivjTFKDK1fPxsnCwrvQmeU79rXqoRSLblCKOz
          # yj1hTdNGCbM+w6DjY1Ub8rrvrTnhQ7k4o+YviiY776BQVvnGCv04zcQLcFGUl5gE
          # 38NflNUVyRRBnMRddWQVDf9VMOyGj/8N7yy5Y0b2qvzfvGn9LhJIZJrglfCm7ymP
          # AbEVtQwdpf5pLGkkeB6zpxxxYu7KyJesF12KwvhHhm4qxFYxldBniYUr+WymXUad
          # DKqC5JlR3XC321Y9YeRq4VzW9v493kHMB65jUr9TU/Qr6cf9tveCX4XSQRjbgbME
          # HMUfpIBvFSDJ3gyICh3WZlXi/EjJKSZp4A==
          # -----END CERTIFICATE-----
          # -----BEGIN CERTIFICATE-----
          # MIIDujCCAqKgAwIBAgILBAAAAAABD4Ym5g0wDQYJKoZIhvcNAQEFBQAwTDEgMB4G
          # A1UECxMXR2xvYmFsU2lnbiBSb290IENBIC0gUjIxEzARBgNVBAoTCkdsb2JhbFNp
          # Z24xEzARBgNVBAMTCkdsb2JhbFNpZ24wHhcNMDYxMjE1MDgwMDAwWhcNMjExMjE1
          # MDgwMDAwWjBMMSAwHgYDVQQLExdHbG9iYWxTaWduIFJvb3QgQ0EgLSBSMjETMBEG
          # A1UEChMKR2xvYmFsU2lnbjETMBEGA1UEAxMKR2xvYmFsU2lnbjCCASIwDQYJKoZI
          # hvcNAQEBBQADggEPADCCAQoCggEBAKbPJA6+Lm8omUVCxKs+IVSbC9N/hHD6ErPL
          # v4dfxn+G07IwXNb9rfF73OX4YJYJkhD10FPe+3t+c4isUoh7SqbKSaZeqKeMWhG8
          # eoLrvozps6yWJQeXSpkqBy+0Hne/ig+1AnwblrjFuTosvNYSuetZfeLQBoZfXklq
          # tTleiDTsvHgMCJiEbKjNS7SgfQx5TfC4LcshytVsW33hoCmEofnTlEnLJGKRILzd
          # C9XZzPnqJworc5HGnRusyMvo4KD0L5CLTfuwNhv2GXqF4G3yYROIXJ/gkwpRl4pa
          # zq+r1feqCapgvdzZX99yqWATXgAByUr6P6TqBwMhAo6CygPCm48CAwEAAaOBnDCB
          # mTAOBgNVHQ8BAf8EBAMCAQYwDwYDVR0TAQH/BAUwAwEB/zAdBgNVHQ4EFgQUm+IH
          # V2ccHsBqBt5ZtJot39wZhi4wNgYDVR0fBC8wLTAroCmgJ4YlaHR0cDovL2NybC5n
          # bG9iYWxzaWduLm5ldC9yb290LXIyLmNybDAfBgNVHSMEGDAWgBSb4gdXZxwewGoG
          # 3lm0mi3f3BmGLjANBgkqhkiG9w0BAQUFAAOCAQEAmYFThxxol4aR7OBKuEQLq4Gs
          # J0/WwbgcQ3izDJr86iw8bmEbTUsp9Z8FHSbBuOmDAGJFtqkIk7mpM0sYmsL4h4hO
          # 291xNBrBVNpGP+DTKqttVCL1OmLNIG+6KYnX3ZHu01yiPqFbQfXf5WRDLenVOavS
          # ot+3i9DAgBkcRcAtjOj4LaR0VknFBbVPFd5uRHg5h6h+u/N5GJG79G+dwfCMNYxd
          # AfvDbbnvRG15RjF+Cv6pgsH/76tuIMRQyV+dTZsXjAzlAcmgQWpzU/qlULRuJQ/7
          # TBj0/VLZjmmx6BEP3ojY+x1J96relc8geMJgEtslQIxq/H5COEBkEveegeGTLg==
          # -----END CERTIFICATE-----
          # -----BEGIN CERTIFICATE-----
          # MIIDXzCCAkegAwIBAgILBAAAAAABIVhTCKIwDQYJKoZIhvcNAQELBQAwTDEgMB4G
          # A1UECxMXR2xvYmFsU2lnbiBSb290IENBIC0gUjMxEzARBgNVBAoTCkdsb2JhbFNp
          # Z24xEzARBgNVBAMTCkdsb2JhbFNpZ24wHhcNMDkwMzE4MTAwMDAwWhcNMjkwMzE4
          # MTAwMDAwWjBMMSAwHgYDVQQLExdHbG9iYWxTaWduIFJvb3QgQ0EgLSBSMzETMBEG
          # A1UEChMKR2xvYmFsU2lnbjETMBEGA1UEAxMKR2xvYmFsU2lnbjCCASIwDQYJKoZI
          # hvcNAQEBBQADggEPADCCAQoCggEBAMwldpB5BngiFvXAg7aEyiie/QV2EcWtiHL8
          # RgJDx7KKnQRfJMsuS+FggkbhUqsMgUdwbN1k0ev1LKMPgj0MK66X17YUhhB5uzsT
          # gHeMCOFJ0mpiLx9e+pZo34knlTifBtc+ycsmWQ1z3rDI6SYOgxXG71uL0gRgykmm
          # KPZpO/bLyCiR5Z2KYVc3rHQU3HTgOu5yLy6c+9C7v/U9AOEGM+iCK65TpjoWc4zd
          # QQ4gOsC0p6Hpsk+QLjJg6VfLuQSSaGjlOCZgdbKfd/+RFO+uIEn8rUAVSNECMWEZ
          # XriX7613t2Saer9fwRPvm2L7DWzgVGkWqQPabumDk3F2xmmFghcCAwEAAaNCMEAw
          # DgYDVR0PAQH/BAQDAgEGMA8GA1UdEwEB/wQFMAMBAf8wHQYDVR0OBBYEFI/wS3+o
          # LkUkrk1Q+mOai97i3Ru8MA0GCSqGSIb3DQEBCwUAA4IBAQBLQNvAUKr+yAzv95ZU
          # RUm7lgAJQayzE4aGKAczymvmdLm6AC2upArT9fHxD4q/c2dKg8dEe3jgr25sbwMp
          # jjM5RcOO5LlXbKr8EpbsU8Yt5CRsuZRj+9xTaGdWPoO4zzUhw8lo/s7awlOqzJCK
          # 6fBdRoyV3XpYKBovHd7NADdBj+1EbddTKJd+82cEHhXXipa0095MJ6RMG3NzdvQX
          # mcIfeg7jLQitChws/zyrVQ4PkX4268NXSb7hLi18YIvDQVETI53O9zJrlAGomecs
          # Mx86OyXShkDOOyyGeMlhLxS67ttVb9+E7gUJTb0o2HLO02JQZR7rkpeDMdmztcpH
          # WD9f
          # -----END CERTIFICATE-----" > /etc/ssl/certs/stapling.crytera.crt

          # echo "-----BEGIN CERTIFICATE-----
          # MIIG1DCCBbygAwIBAgIMGhZuRK+L7LEopP0rMA0GCSqGSIb3DQEBCwUAMEwxCzAJ
          # BgNVBAYTAkJFMRkwFwYDVQQKExBHbG9iYWxTaWduIG52LXNhMSIwIAYDVQQDExlB
          # bHBoYVNTTCBDQSAtIFNIQTI1NiAtIEcyMB4XDTE3MDgwNjEwNDAzNVoXDTE4MDgw
          # NzEwNDAzNVowOzEhMB8GA1UECxMYRG9tYWluIENvbnRyb2wgVmFsaWRhdGVkMRYw
          # FAYDVQQDDA0qLmNyeXRlcmEuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIB
          # CgKCAQEAsqxiz/R27rVIXvkTI4AQFe3vG40bWPTYpj6rl6AVid+9NUTrEgtG0J4Q
          # HGmxMpcNxgIJ9VPMKLDuyLqFB70bYASz8UHC2sqmFYWAcyExPsXbDrRGlSramoK8
          # aqF6Zp8NuEUsvRrErokCzMwiaZ3NO66GNOdQj3Ta4djC/gA6mZgVx5L1O9aDi6lL
          # X5/cw7QMhNgd1hwlPccBxxI1BsfNdqjV2M0WEOzt/pF786sQIjXsIr4Jh3i8dOhf
          # qZQBl6AJQB5elQEzvOMuiHvRwnRqldvRTtBSwNfr+DX9VGkI4eTpZuPhHdwPt5Cn
          # EUvnDMQrJovsrgZHTYbPQHb8cz+I7wIDAQABo4IDxTCCA8EwDgYDVR0PAQH/BAQD
          # AgWgMIGJBggrBgEFBQcBAQR9MHswQgYIKwYBBQUHMAKGNmh0dHA6Ly9zZWN1cmUy
          # LmFscGhhc3NsLmNvbS9jYWNlcnQvZ3NhbHBoYXNoYTJnMnIxLmNydDA1BggrBgEF
          # BQcwAYYpaHR0cDovL29jc3AyLmdsb2JhbHNpZ24uY29tL2dzYWxwaGFzaGEyZzIw
          # VwYDVR0gBFAwTjBCBgorBgEEAaAyAQoKMDQwMgYIKwYBBQUHAgEWJmh0dHBzOi8v
          # d3d3Lmdsb2JhbHNpZ24uY29tL3JlcG9zaXRvcnkvMAgGBmeBDAECATAJBgNVHRME
          # AjAAMD4GA1UdHwQ3MDUwM6AxoC+GLWh0dHA6Ly9jcmwyLmFscGhhc3NsLmNvbS9n
          # cy9nc2FscGhhc2hhMmcyLmNybDAlBgNVHREEHjAcgg0qLmNyeXRlcmEuY29tggtj
          # cnl0ZXJhLmNvbTAdBgNVHSUEFjAUBggrBgEFBQcDAQYIKwYBBQUHAwIwHQYDVR0O
          # BBYEFHAVo045rofxzSpC+H/d05IElP48MB8GA1UdIwQYMBaAFPXN1TwIUPlqTzq3
          # l9pWg+Zp0mj3MIIB9wYKKwYBBAHWeQIEAgSCAecEggHjAeEAdwBWFAaaL9fC7NP1
          # 4b1Esj7HRna5vJkRXMDvlJhV1onQ3QAAAV23Id/NAAAEAwBIMEYCIQDYebA8ZabJ
          # Nd9fav/EDPo2eeC2avpcQYzLWVg86ldR+QIhAIAKvhwXtaQN3ZALY07ejQ2YT6qd
          # 82sDD4CCm8HpGonMAHYApLkJkLQYWBSHuxOizGdwCjw1mAT5G9+443fNDsgN3BAA
          # AAFdtyHizAAABAMARzBFAiAipdPPpoNo0cjRvyhsOVO/ubsgfCtBIhQ0RAT021Pi
          # BAIhAO/dwLyqZfkMj43U+nVlLWNJotP8w58sKgGn080LliUZAHYAu9nfvB+KcbWT
          # lCOXqpJ7RzhXlQqrUugakJZkNo4e0YUAAAFdtyHjgwAABAMARzBFAiBooLHkC4uv
          # I8NhRCWi4zONA4gYU4oTqzO8IawvxUxlugIhAKya0E+WgmWPiagrIyHFExTbNyLY
          # GX0+1q3dPqpx2il2AHYA7ku9t3XOYLrhQmkfq+GeZqMPfl+wctiDAMR7iXqo/csA
          # AAFdtyHlvgAABAMARzBFAiAAuC9PdCUgkyKRGlBawMe6KdB3vKyxkLqOAe85kThJ
          # AAIhAIyC8LNslPHiPWbdrrhEsT9aSxywOf1FI6RWJ7bK0HZ2MA0GCSqGSIb3DQEB
          # CwUAA4IBAQB2bVUxndrThO56Q/TimpntoIWXjTPb2RuriqxCu9833/ILI9kTBxtF
          # cFKqZn2LHkEEVYq7ZF0K3XvzhuEXy30s/ldbX8ncV7xGJJVOT0RlMn5qKIndVxkz
          # h3VKbZ+qvO+ixyPsXGbJlRz6rjOgWRgMZEIKvWNIhnFVTk5mpylMcFrGk06ttZxF
          # tlqECTpTEfGplJmwoXIXhS7Kg0jDTTjlW+701z/trsDWKJOhSQmQHnMBFQDRzI7J
          # 31VLAzqgOUABqoqXEnLKgvZ4j+tHKx4CqWKrHHrfOnmseKgTigAqjx3DZEXkcoPk
          # DCG7rnGZE83yo8O14Z2+TesFjPr52nNX
          # -----END CERTIFICATE-----
          # -----BEGIN CERTIFICATE-----
          # MIIETTCCAzWgAwIBAgILBAAAAAABRE7wNjEwDQYJKoZIhvcNAQELBQAwVzELMAkG
          # A1UEBhMCQkUxGTAXBgNVBAoTEEdsb2JhbFNpZ24gbnYtc2ExEDAOBgNVBAsTB1Jv
          # b3QgQ0ExGzAZBgNVBAMTEkdsb2JhbFNpZ24gUm9vdCBDQTAeFw0xNDAyMjAxMDAw
          # MDBaFw0yNDAyMjAxMDAwMDBaMEwxCzAJBgNVBAYTAkJFMRkwFwYDVQQKExBHbG9i
          # YWxTaWduIG52LXNhMSIwIAYDVQQDExlBbHBoYVNTTCBDQSAtIFNIQTI1NiAtIEcy
          # MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA2gHs5OxzYPt+j2q3xhfj
          # kmQy1KwA2aIPue3ua4qGypJn2XTXXUcCPI9A1p5tFM3D2ik5pw8FCmiiZhoexLKL
          # dljlq10dj0CzOYvvHoN9ItDjqQAu7FPPYhmFRChMwCfLew7sEGQAEKQFzKByvkFs
          # MVtI5LHsuSPrVU3QfWJKpbSlpFmFxSWRpv6mCZ8GEG2PgQxkQF5zAJrgLmWYVBAA
          # cJjI4e00X9icxw3A1iNZRfz+VXqG7pRgIvGu0eZVRvaZxRsIdF+ssGSEj4k4HKGn
          # kCFPAm694GFn1PhChw8K98kEbSqpL+9Cpd/do1PbmB6B+Zpye1reTz5/olig4het
          # ZwIDAQABo4IBIzCCAR8wDgYDVR0PAQH/BAQDAgEGMBIGA1UdEwEB/wQIMAYBAf8C
          # AQAwHQYDVR0OBBYEFPXN1TwIUPlqTzq3l9pWg+Zp0mj3MEUGA1UdIAQ+MDwwOgYE
          # VR0gADAyMDAGCCsGAQUFBwIBFiRodHRwczovL3d3dy5hbHBoYXNzbC5jb20vcmVw
          # b3NpdG9yeS8wMwYDVR0fBCwwKjAooCagJIYiaHR0cDovL2NybC5nbG9iYWxzaWdu
          # Lm5ldC9yb290LmNybDA9BggrBgEFBQcBAQQxMC8wLQYIKwYBBQUHMAGGIWh0dHA6
          # Ly9vY3NwLmdsb2JhbHNpZ24uY29tL3Jvb3RyMTAfBgNVHSMEGDAWgBRge2YaRQ2X
          # yolQL30EzTSo//z9SzANBgkqhkiG9w0BAQsFAAOCAQEAYEBoFkfnFo3bXKFWKsv0
          # XJuwHqJL9csCP/gLofKnQtS3TOvjZoDzJUN4LhsXVgdSGMvRqOzm+3M+pGKMgLTS
          # xRJzo9P6Aji+Yz2EuJnB8br3n8NA0VgYU8Fi3a8YQn80TsVD1XGwMADH45CuP1eG
          # l87qDBKOInDjZqdUfy4oy9RU0LMeYmcI+Sfhy+NmuCQbiWqJRGXy2UzSWByMTsCV
          # odTvZy84IOgu/5ZR8LrYPZJwR2UcnnNytGAMXOLRc3bgr07i5TelRS+KIz6HxzDm
          # MTh89N1SyvNTBCVXVmaU6Avu5gMUTu79bZRknl7OedSyps9AsUSoPocZXun4IRZZ
          # Uw==
          # -----END CERTIFICATE-----
          # -----BEGIN CERTIFICATE-----
          # MIIESzCCAzOgAwIBAgIOSMqBefg+ikLz9c3isT8wDQYJKoZIhvcNAQELBQAwTDEg
          # MB4GA1UECxMXR2xvYmFsU2lnbiBSb290IENBIC0gUjMxEzARBgNVBAoTCkdsb2Jh
          # bFNpZ24xEzARBgNVBAMTCkdsb2JhbFNpZ24wHhcNMTYxMDE0MDAwMDAwWhcNMjQw
          # MjIwMTAwMDAwWjBMMQswCQYDVQQGEwJCRTEZMBcGA1UEChMQR2xvYmFsU2lnbiBu
          # di1zYTEiMCAGA1UEAxMZQWxwaGFTU0wgQ0EgLSBTSEEyNTYgLSBHMjCCASIwDQYJ
          # KoZIhvcNAQEBBQADggEPADCCAQoCggEBANoB7OTsc2D7fo9qt8YX45JkMtSsANmi
          # D7nt7muKhsqSZ9l0111HAjyPQNaebRTNw9opOacPBQpoomYaHsSyi3ZY5atdHY9A
          # szmL7x6DfSLQ46kALuxTz2IZhUQoTMAny3sO7BBkABCkBcygcr5BbDFbSOSx7Lkj
          # 61VN0H1iSqW0paRZhcUlkab+pgmfBhBtj4EMZEBecwCa4C5lmFQQAHCYyOHtNF/Y
          # nMcNwNYjWUX8/lV6hu6UYCLxrtHmVUb2mcUbCHRfrLBkhI+JOByhp5AhTwJuveBh
          # Z9T4QocPCvfJBG0qqS/vQqXf3aNT25gegfmacnta3k8+f6JYoOIXrWcCAwEAAaOC
          # ASkwggElMA4GA1UdDwEB/wQEAwIBBjASBgNVHRMBAf8ECDAGAQH/AgEAMB0GA1Ud
          # DgQWBBT1zdU8CFD5ak86t5faVoPmadJo9zAfBgNVHSMEGDAWgBSP8Et/qC5FJK5N
          # UPpjmove4t0bvDA+BggrBgEFBQcBAQQyMDAwLgYIKwYBBQUHMAGGImh0dHA6Ly9v
          # Y3NwMi5nbG9iYWxzaWduLmNvbS9yb290cjMwNgYDVR0fBC8wLTAroCmgJ4YlaHR0
          # cDovL2NybC5nbG9iYWxzaWduLmNvbS9yb290LXIzLmNybDBHBgNVHSAEQDA+MDwG
          # BFUdIAAwNDAyBggrBgEFBQcCARYmaHR0cHM6Ly93d3cuZ2xvYmFsc2lnbi5jb20v
          # cmVwb3NpdG9yeS8wDQYJKoZIhvcNAQELBQADggEBAFsnfA30jsQHf3U8XxeJUHhV
          # EpESFSNyt7yf/zboXTvy7RG7hgFugyWfcS4WIhHIy9yYoTfSuFCj73Clc6x62EP7
          # 5ros/YN38Q7zjaJKdSdJJ5+9Kq4fFQ5itED807y5maAzrMG4indOACzP9swinQ7C
          # daRO4z00bN2CKgJd4S0wQ6hQYqodPYLoRVZI2yqAxNGBI0DozuwiIQpYLPMk/Rza
          # vArdFMtyyKsWVCgQnRBCIS7AXUHHQcCasd5fg3WhZSLJRInEXALy4k5bGxjtNeby
          # CV/akHyNQxN+Lw3E4hxAT4wK0emK+UOQP3RbzWnljGbrVy56GKcQupSlAkclrDo=
          # -----END CERTIFICATE-----
          # -----BEGIN CERTIFICATE-----
          # MIIDdTCCAl2gAwIBAgILBAAAAAABFUtaw5QwDQYJKoZIhvcNAQEFBQAwVzELMAkG
          # A1UEBhMCQkUxGTAXBgNVBAoTEEdsb2JhbFNpZ24gbnYtc2ExEDAOBgNVBAsTB1Jv
          # b3QgQ0ExGzAZBgNVBAMTEkdsb2JhbFNpZ24gUm9vdCBDQTAeFw05ODA5MDExMjAw
          # MDBaFw0yODAxMjgxMjAwMDBaMFcxCzAJBgNVBAYTAkJFMRkwFwYDVQQKExBHbG9i
          # YWxTaWduIG52LXNhMRAwDgYDVQQLEwdSb290IENBMRswGQYDVQQDExJHbG9iYWxT
          # aWduIFJvb3QgQ0EwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDaDuaZ
          # jc6j40+Kfvvxi4Mla+pIH/EqsLmVEQS98GPR4mdmzxzdzxtIK+6NiY6arymAZavp
          # xy0Sy6scTHAHoT0KMM0VjU/43dSMUBUc71DuxC73/OlS8pF94G3VNTCOXkNz8kHp
          # 1Wrjsok6Vjk4bwY8iGlbKk3Fp1S4bInMm/k8yuX9ifUSPJJ4ltbcdG6TRGHRjcdG
          # snUOhugZitVtbNV4FpWi6cgKOOvyJBNPc1STE4U6G7weNLWLBYy5d4ux2x8gkasJ
          # U26Qzns3dLlwR5EiUWMWea6xrkEmCMgZK9FGqkjWZCrXgzT/LCrBbBlDSgeF59N8
          # 9iFo7+ryUp9/k5DPAgMBAAGjQjBAMA4GA1UdDwEB/wQEAwIBBjAPBgNVHRMBAf8E
          # BTADAQH/MB0GA1UdDgQWBBRge2YaRQ2XyolQL30EzTSo//z9SzANBgkqhkiG9w0B
          # AQUFAAOCAQEA1nPnfE920I2/7LqivjTFKDK1fPxsnCwrvQmeU79rXqoRSLblCKOz
          # yj1hTdNGCbM+w6DjY1Ub8rrvrTnhQ7k4o+YviiY776BQVvnGCv04zcQLcFGUl5gE
          # 38NflNUVyRRBnMRddWQVDf9VMOyGj/8N7yy5Y0b2qvzfvGn9LhJIZJrglfCm7ymP
          # AbEVtQwdpf5pLGkkeB6zpxxxYu7KyJesF12KwvhHhm4qxFYxldBniYUr+WymXUad
          # DKqC5JlR3XC321Y9YeRq4VzW9v493kHMB65jUr9TU/Qr6cf9tveCX4XSQRjbgbME
          # HMUfpIBvFSDJ3gyICh3WZlXi/EjJKSZp4A==
          # -----END CERTIFICATE-----
          # -----BEGIN CERTIFICATE-----
          # MIIEaTCCA1GgAwIBAgILBAAAAAABRE7wQkcwDQYJKoZIhvcNAQELBQAwVzELMAkG
          # A1UEBhMCQkUxGTAXBgNVBAoTEEdsb2JhbFNpZ24gbnYtc2ExEDAOBgNVBAsTB1Jv
          # b3QgQ0ExGzAZBgNVBAMTEkdsb2JhbFNpZ24gUm9vdCBDQTAeFw0xNDAyMjAxMDAw
          # MDBaFw0yNDAyMjAxMDAwMDBaMGYxCzAJBgNVBAYTAkJFMRkwFwYDVQQKExBHbG9i
          # YWxTaWduIG52LXNhMTwwOgYDVQQDEzNHbG9iYWxTaWduIE9yZ2FuaXphdGlvbiBW
          # YWxpZGF0aW9uIENBIC0gU0hBMjU2IC0gRzIwggEiMA0GCSqGSIb3DQEBAQUAA4IB
          # DwAwggEKAoIBAQDHDmw/I5N/zHClnSDDDlM/fsBOwphJykfVI+8DNIV0yKMCLkZc
          # C33JiJ1Pi/D4nGyMVTXbv/Kz6vvjVudKRtkTIso21ZvBqOOWQ5PyDLzm+ebomchj
          # SHh/VzZpGhkdWtHUfcKc1H/hgBKueuqI6lfYygoKOhJJomIZeg0k9zfrtHOSewUj
          # mxK1zusp36QUArkBpdSmnENkiN74fv7j9R7l/tyjqORmMdlMJekYuYlZCa7pnRxt
          # Nw9KHjUgKOKv1CGLAcRFrW4rY6uSa2EKTSDtc7p8zv4WtdufgPDWi2zZCHlKT3hl
          # 2pK8vjX5s8T5J4BO/5ZS5gIg4Qdz6V0rvbLxAgMBAAGjggElMIIBITAOBgNVHQ8B
          # Af8EBAMCAQYwEgYDVR0TAQH/BAgwBgEB/wIBADAdBgNVHQ4EFgQUlt5h8b0cFilT
          # HMDMfTuDAEDmGnwwRwYDVR0gBEAwPjA8BgRVHSAAMDQwMgYIKwYBBQUHAgEWJmh0
          # dHBzOi8vd3d3Lmdsb2JhbHNpZ24uY29tL3JlcG9zaXRvcnkvMDMGA1UdHwQsMCow
          # KKAmoCSGImh0dHA6Ly9jcmwuZ2xvYmFsc2lnbi5uZXQvcm9vdC5jcmwwPQYIKwYB
          # BQUHAQEEMTAvMC0GCCsGAQUFBzABhiFodHRwOi8vb2NzcC5nbG9iYWxzaWduLmNv
          # bS9yb290cjEwHwYDVR0jBBgwFoAUYHtmGkUNl8qJUC99BM00qP/8/UswDQYJKoZI
          # hvcNAQELBQADggEBAEYq7l69rgFgNzERhnF0tkZJyBAW/i9iIxerH4f4gu3K3w4s
          # 32R1juUYcqeMOovJrKV3UPfvnqTgoI8UV6MqX+x+bRDmuo2wCId2Dkyy2VG7EQLy
          # XN0cvfNVlg/UBsD84iOKJHDTu/B5GqdhcIOKrwbFINihY9Bsrk8y1658GEV1BSl3
          # 30JAZGSGvip2CTFvHST0mdCF/vIhCPnG9vHQWe3WVjwIKANnuvD58ZAWR65n5ryA
          # SOlCdjSXVWkkDoPWoC209fN5ikkodBpBocLTJIg1MGCUF7ThBCIxPTsvFwayuJ2G
          # K1pp74P1S8SqtCr4fKGxhZSM9AyHDPSsQPhZSZg=
          # -----END CERTIFICATE-----
          # -----BEGIN CERTIFICATE-----
          # MIIEYjCCA0qgAwIBAgILBAAAAAABMYnGRMkwDQYJKoZIhvcNAQELBQAwTDEgMB4G
          # A1UECxMXR2xvYmFsU2lnbiBSb290IENBIC0gUjMxEzARBgNVBAoTCkdsb2JhbFNp
          # Z24xEzARBgNVBAMTCkdsb2JhbFNpZ24wHhcNMTEwODAyMTAwMDAwWhcNMjIwODAy
          # MTAwMDAwWjBmMQswCQYDVQQGEwJCRTEZMBcGA1UEChMQR2xvYmFsU2lnbiBudi1z
          # YTE8MDoGA1UEAxMzR2xvYmFsU2lnbiBPcmdhbml6YXRpb24gVmFsaWRhdGlvbiBD
          # QSAtIFNIQTI1NiAtIEcyMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA
          # xw5sPyOTf8xwpZ0gww5TP37ATsKYScpH1SPvAzSFdMijAi5GXAt9yYidT4vw+Jxs
          # jFU127/ys+r741bnSkbZEyLKNtWbwajjlkOT8gy85vnm6JnIY0h4f1c2aRoZHVrR
          # 1H3CnNR/4YASrnrqiOpX2MoKCjoSSaJiGXoNJPc367RzknsFI5sStc7rKd+kFAK5
          # AaXUppxDZIje+H7+4/Ue5f7co6jkZjHZTCXpGLmJWQmu6Z0cbTcPSh41ICjir9Qh
          # iwHERa1uK2OrkmthCk0g7XO6fM7+FrXbn4Dw1ots2Qh5Sk94ZdqSvL41+bPE+SeA
          # Tv+WUuYCIOEHc+ldK72y8QIDAQABo4IBKTCCASUwDgYDVR0PAQH/BAQDAgEGMBIG
          # A1UdEwEB/wQIMAYBAf8CAQAwHQYDVR0OBBYEFJbeYfG9HBYpUxzAzH07gwBA5hp8
          # MEcGA1UdIARAMD4wPAYEVR0gADA0MDIGCCsGAQUFBwIBFiZodHRwczovL3d3dy5n
          # bG9iYWxzaWduLmNvbS9yZXBvc2l0b3J5LzA2BgNVHR8ELzAtMCugKaAnhiVodHRw
          # Oi8vY3JsLmdsb2JhbHNpZ24ubmV0L3Jvb3QtcjMuY3JsMD4GCCsGAQUFBwEBBDIw
          # MDAuBggrBgEFBQcwAYYiaHR0cDovL29jc3AyLmdsb2JhbHNpZ24uY29tL3Jvb3Ry
          # MzAfBgNVHSMEGDAWgBSP8Et/qC5FJK5NUPpjmove4t0bvDANBgkqhkiG9w0BAQsF
          # AAOCAQEAugYpwLQZjCERwJQRnrs91NVDQPafuyULI2i1Gvf6VGTMKxP5IfBEreHo
          # FVjb7v3bok3MGI8Nmm3DawGhMfCNvABAzDlfh2FRbfSV6uoVNT5AhcBi1aE0/niq
          # qLJaOfM3Qfuc6D5xSlvr+GlYoeDGk3fpumeS62VYkHBzQn2v9CMmeReq+qS7meVE
          # b2WB58rrVcj0ticRIXSUvGu3dGIpxM2uR/LmQlt4hgVhy5CqeYnfBH6xJnBLjUAf
          # hHvA+wfmyLdOkfQ1A+3o60EQF0m0YsinLPLhTI8DLPMWN11n8aQ5eUmjwF3MVfkh
          # gA/7zuIpalhQ6abX6xwyNrVip8H65g==
          # -----END CERTIFICATE-----
          # -----BEGIN CERTIFICATE-----
          # MIIEYDCCA0igAwIBAgILBAAAAAABL07hRQwwDQYJKoZIhvcNAQEFBQAwVzELMAkG
          # A1UEBhMCQkUxGTAXBgNVBAoTEEdsb2JhbFNpZ24gbnYtc2ExEDAOBgNVBAsTB1Jv
          # b3QgQ0ExGzAZBgNVBAMTEkdsb2JhbFNpZ24gUm9vdCBDQTAeFw0xMTA0MTMxMDAw
          # MDBaFw0yMjA0MTMxMDAwMDBaMF0xCzAJBgNVBAYTAkJFMRkwFwYDVQQKExBHbG9i
          # YWxTaWduIG52LXNhMTMwMQYDVQQDEypHbG9iYWxTaWduIE9yZ2FuaXphdGlvbiBW
          # YWxpZGF0aW9uIENBIC0gRzIwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIB
          # AQDdNR3yIFQmGtDvpW+Bdllw3Of01AMkHyQOnSKf1Ccyeit87ovjYWI4F6+0S3qf
          # ZyEcLZVUunm6tsTyDSF0F2d04rFkCJlgePtnwkv3J41vNnbPMYzl8QbX3FcOW6zu
          # zi2rqqlwLwKGyLHQCAeV6irs0Z7kNlw7pja1Q4ur944+ABv/hVlrYgGNguhKujiz
          # 4MP0bRmn6gXdhGfCZsckAnNate6kGdn8AM62pI3ffr1fsjqdhDFPyGMM5NgNUqN+
          # ARvUZ6UYKOsBp4I82Y4d5UcNuotZFKMfH0vq4idGhs6dOcRmQafiFSNrVkfB7cVT
          # 5NSAH2v6gEaYsgmmD5W+ZoiTAgMBAAGjggElMIIBITAOBgNVHQ8BAf8EBAMCAQYw
          # EgYDVR0TAQH/BAgwBgEB/wIBADAdBgNVHQ4EFgQUXUayjcRLdBy77fVztjq3OI91
          # nn4wRwYDVR0gBEAwPjA8BgRVHSAAMDQwMgYIKwYBBQUHAgEWJmh0dHBzOi8vd3d3
          # Lmdsb2JhbHNpZ24uY29tL3JlcG9zaXRvcnkvMDMGA1UdHwQsMCowKKAmoCSGImh0
          # dHA6Ly9jcmwuZ2xvYmFsc2lnbi5uZXQvcm9vdC5jcmwwPQYIKwYBBQUHAQEEMTAv
          # MC0GCCsGAQUFBzABhiFodHRwOi8vb2NzcC5nbG9iYWxzaWduLmNvbS9yb290cjEw
          # HwYDVR0jBBgwFoAUYHtmGkUNl8qJUC99BM00qP/8/UswDQYJKoZIhvcNAQEFBQAD
          # ggEBABvgiADHBREc/6stSEJSzSBo53xBjcEnxSxZZ6CaNduzUKcbYumlO/q2IQen
          # fPMOK25+Lk2TnLryhj5jiBDYW2FQEtuHrhm70t8ylgCoXtwtI7yw07VKoI5lkS/Z
          # 9oL2dLLffCbvGSuXL+Ch7rkXIkg/pfcNYNUNUUflWP63n41edTzGQfDPgVRJEcYX
          # pOBWYdw9P91nbHZF2krqrhqkYE/Ho9aqp9nNgSvBZnWygI/1h01fwlr1kMbawb30
          # hag8IyrhFHvBN91i0ZJsumB9iOQct+R2UTjEqUdOqCsukNK1OFHrwZyKarXMsh3o
          # wFZUTKiL8IkyhtyTMr5NGvo1dbU=
          # -----END CERTIFICATE-----
          # -----BEGIN CERTIFICATE-----
          # MIIEMTCCAxmgAwIBAgILBAAAAAABMYnGOdwwDQYJKoZIhvcNAQELBQAwTDEgMB4G
          # A1UECxMXR2xvYmFsU2lnbiBSb290IENBIC0gUjMxEzARBgNVBAoTCkdsb2JhbFNp
          # Z24xEzARBgNVBAMTCkdsb2JhbFNpZ24wHhcNMTEwODAyMTAwMDAwWhcNMjIwODAy
          # MTAwMDAwWjA3MREwDwYDVQQKEwhBbHBoYVNTTDEiMCAGA1UEAxMZQWxwaGFTU0wg
          # Q0EgLSBTSEEyNTYgLSBHMjCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEB
          # ANoB7OTsc2D7fo9qt8YX45JkMtSsANmiD7nt7muKhsqSZ9l0111HAjyPQNaebRTN
          # w9opOacPBQpoomYaHsSyi3ZY5atdHY9AszmL7x6DfSLQ46kALuxTz2IZhUQoTMAn
          # y3sO7BBkABCkBcygcr5BbDFbSOSx7Lkj61VN0H1iSqW0paRZhcUlkab+pgmfBhBt
          # j4EMZEBecwCa4C5lmFQQAHCYyOHtNF/YnMcNwNYjWUX8/lV6hu6UYCLxrtHmVUb2
          # mcUbCHRfrLBkhI+JOByhp5AhTwJuveBhZ9T4QocPCvfJBG0qqS/vQqXf3aNT25ge
          # gfmacnta3k8+f6JYoOIXrWcCAwEAAaOCAScwggEjMA4GA1UdDwEB/wQEAwIBBjAS
          # BgNVHRMBAf8ECDAGAQH/AgEAMB0GA1UdDgQWBBT1zdU8CFD5ak86t5faVoPmadJo
          # 9zBFBgNVHSAEPjA8MDoGBFUdIAAwMjAwBggrBgEFBQcCARYkaHR0cHM6Ly93d3cu
          # YWxwaGFzc2wuY29tL3JlcG9zaXRvcnkvMDYGA1UdHwQvMC0wK6ApoCeGJWh0dHA6
          # Ly9jcmwuZ2xvYmFsc2lnbi5uZXQvcm9vdC1yMy5jcmwwPgYIKwYBBQUHAQEEMjAw
          # MC4GCCsGAQUFBzABhiJodHRwOi8vb2NzcDIuZ2xvYmFsc2lnbi5jb20vcm9vdHIz
          # MB8GA1UdIwQYMBaAFI/wS3+oLkUkrk1Q+mOai97i3Ru8MA0GCSqGSIb3DQEBCwUA
          # A4IBAQCsXKadiWS87Tm5J5Oo1LKRJ8jSO5hOppCNqLZeIEmgPk+JK7ReNnsPBUUM
          # 5yv0VVIU9EO+pPbrPV9Hh8RMHxMJMTk4e0Nmks+C7yAGytwu/2jmMJ/eCxmSjh3B
          # lBFArzM22zcOCBBSwa8Md2yww3qKmpDez3ONw4QrnwajyinF3YpI8opg/jVqG9B9
          # 1jqUEnCfRC8zuZVDiK7S6d3v7as24HOyFGKCSRrylYGr2RIbngnwonL8TzbQbiv5
          # R+/MeTmEbHHhKH1x5aNWau5XyNEdj34tAG3c0LR6lUpUjRop5MKxFk23ph4i1+CB
          # Nm+uXmPCXTU4uHD+4WWdpJn5/iAY
          # -----END CERTIFICATE-----" > /etc/ssl/certs/crytera.com.crt

          # echo "-----BEGIN CERTIFICATE-----
          # MIIEowIBAAKCAQEAsqxiz/R27rVIXvkTI4AQFe3vG40bWPTYpj6rl6AVid+9NUTr
          # EgtG0J4QHGmxMpcNxgIJ9VPMKLDuyLqFB70bYASz8UHC2sqmFYWAcyExPsXbDrRG
          # lSramoK8aqF6Zp8NuEUsvRrErokCzMwiaZ3NO66GNOdQj3Ta4djC/gA6mZgVx5L1
          # O9aDi6lLX5/cw7QMhNgd1hwlPccBxxI1BsfNdqjV2M0WEOzt/pF786sQIjXsIr4J
          # h3i8dOhfqZQBl6AJQB5elQEzvOMuiHvRwnRqldvRTtBSwNfr+DX9VGkI4eTpZuPh
          # HdwPt5CnEUvnDMQrJovsrgZHTYbPQHb8cz+I7wIDAQABAoIBAQCKspr6BzGT2BHX
          # 983NjwntnAgzAPSrt1W+p4OYbmKJ5q7//QHlve843ppvE/TD6tJ8VPTaBjTDmaWj
          # GHdQLJJllQECVSQnp4wJxNqThL6vlfOYlIT+IogTzUzqEXPs2adS1hAGtBLd0enk
          # hMpp5l985tuzkaTN185Z52RmvFLBCysgXhHEYuBn8DnIL0GL5CRJV1QGEVczBD3N
          # aHcnjz3i8It5P9Ii9zRuVwz/WhNF9ZRFTfyd0VTA4lZfqc2kAt+bv+blt+YSGQgP
          # A4cTh+VIZUZPgB78gYkbPSFe4eCVED52LBPX8qpjo5d0hsTnRtFj5MLraXGo00vc
          # 29nxxx5BAoGBAOhCV/H7WhuE3PI7Eh1W/RRiYG2JAW6LxOm8hUaAYupaIGbH8H0v
          # uACBbH1nAv+vblxaqYvYD7EyTFkBTyHtP3T8wp4FkdCr+7pihIk8aEn+LMDjGhDD
          # oQ1KcMdNFmIHLroy9efsZPcwbnNggRVf3+0DYdSXw7ZGl3ZLRLbpfL4xAoGBAMTv
          # 1VMWg/h2ThiCWxOTIYG5KLBYMCdhjHX4lbRsx21mrD/0+koQXs6vW1f8pOk6fKIn
          # dL6E3BLTydTUfV3rnCuk1Nwtk/sk9M7V4120A+QLqNS3e3NuSBn7hjTzoZjcTDEf
          # fJn6EejsWSBL6KbfYmw8wbH+/XN6Q7YR4/gTp1EfAoGAeVOm006FHJkEPjljVhZJ
          # 8CsPykhmihPTUnJbgJ+yjE92W5qYYxzZVtJFFSEJrP08flwR825zjBIFVf1cFBH2
          # MyuSkq/AIyykPBIYwAPhSr3PLRe1VwqKiAHZ9hKr3Zt46mWSlYuklogjOnwwEjVa
          # KVq58S8yWnZ3yqC5DX/c3RECgYBG73RRZ0zF1CcxINMZa+enyD/ltP4zUSm83Htf
          # 78atm0v0BZOZ1eewXu1x9eiYsZ5u8fNVJJn4lhye8qLtj45DEi4x2KDy107uqZAq
          # EktMev6nECgBXfnOkhC3RgIxAzjWgNbqx25oDanUvkLgyJm1DvVd3dEBJUr6a9tH
          # YhzkVQKBgF2RfP0lJrKMhn6ZFLklBxjCFfviGefYR+A+TdOVA3oghHBX9kvO6wkI
          # yo5atGzs1+VHK9AEdrgYvK28qJiWa3dL59LVKeniA9bEyGPGoST06MN+iGEIbl1W
          # tU7gLvj+LFHB+Zg3OC2EOBM5MDJd7bIkvuLyqbgp2ArQp81N1Qtd
          # -----END CERTIFICATE-----" > /etc/ssl/private/crytera.com.key

          /etc/init.d/php5-fpm restart
          /etc/init.d/nginx restart

          /usr/local/bin/cfn-signal -e 0 -r 'server setup complete' "${WaitHandleWEB}"  > /tmp/userdata.log

  WaitHandleWEB:
    Type: "AWS::CloudFormation::WaitConditionHandle"

  WaitCondition:
    Type: "AWS::CloudFormation::WaitCondition"
    Properties:
      Handle: !Ref "WaitHandleWEB"
      Timeout: '300'

  # Auto Scaling Group Basic Setup
  WebScalingGroup: 
    Type: "AWS::AutoScaling::AutoScalingGroup"
    Properties:
      MinSize: !Ref "PMASMIN"
      MaxSize: !Ref "PMASMAX"
      DesiredCapacity: !Ref "PMASDES"
      LaunchConfigurationName:
        Ref: "LaunchConfiguration"
      VPCZoneIdentifier:
        Ref: "PMPublicSubnets"
      LoadBalancerNames:
      - Ref: "PMWEBLoadBalancer"
      HealthCheckGracePeriod: "300"
      HealthCheckType: "ELB"
      Tags:
      - Key: "Name"
        Value: !Sub "${PMServerEnv}-WEBserver"
        PropagateAtLaunch: 'true'

  # Auto ScalingUp Policy - Basic Setup
  WebServerScaleUpPolicy:
    Type: "AWS::AutoScaling::ScalingPolicy"
    Properties:
      AdjustmentType: "ChangeInCapacity"
      AutoScalingGroupName:
        Ref: "WebScalingGroup"
      Cooldown: '300'
      ScalingAdjustment: '1'

  # Auto ScalingDown Policy - Basic Setup
  WebServerScaleDownPolicy:
    Type: "AWS::AutoScaling::ScalingPolicy"
    Properties:
      AdjustmentType: "ChangeInCapacity"
      AutoScalingGroupName:
        Ref: "WebScalingGroup"
      Cooldown: '300'
      ScalingAdjustment: '-1'


Outputs:

  WebScalingGroup: 
    Description: "Auto Scaling Group Reference ID"
    Value: !Ref "WebScalingGroup"

  WebServerScaleUpPolicy: 
    Description: "Auto Scaling Up Policy Reference ID"
    Value: !Ref "WebServerScaleUpPolicy"

  WebServerScaleDownPolicy: 
    Description: "Auto Scaling Down Policy Reference ID"
    Value: !Ref "WebServerScaleDownPolicy"


